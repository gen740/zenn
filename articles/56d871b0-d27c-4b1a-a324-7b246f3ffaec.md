---
title: "Nix ã§ Setup ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚ã‚‹ Custom Package ã‚’ä½œã‚‹"
emoji: "ğŸ˜€"
type: "tech"
topics: ["Nix", "å‚™å¿˜éŒ²"]
published: true
---

# ã¯ã˜ã‚ã«

å··ã«æº¢ã‚Œã‚‹ Nix ã®è¨˜äº‹ã«ã¯ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œã‚‹ã‚„ã‚Šæ–¹ã¯ãŸãã•ã‚“ã‚ã‚‹ãŒã€ãã‚Œã« shellHook ãªã©ã‚’ã‹ã¶ã›ãŸã‚„ã‚Šæ–¹ã®è§£èª¬ã¯ãªã„ã€‚
`pythonPackage.venvShellHook` ã‚’å‚è€ƒã«ãƒŸãƒ‹ãƒãƒ ãª `setupHook` ã‚’å«ã‚“ã  package ã®ä½œã‚Šæ–¹ã‚’ç´¹ä»‹ã™ã‚‹ã€‚

::::::::message
éƒ½åˆä¸Š flake.nix ã‚’ä½¿ã£ãŸã‚„ã‚Šæ–¹ã®ã¿ã‚’è§£èª¬ã™ã‚‹ã€‚
::::::::

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

### flake.nix

```nix
{
  description = "Flake shell";
  inputs.nixpkgs.url = "github:NixOS/nixpkgs/nixpkgs-unstable";
  inputs.flake-utils.url = "github:numtide/flake-utils";

  outputs =
    { nixpkgs, flake-utils, ... }:
    flake-utils.lib.eachDefaultSystem (
      system:
      let
        pkgs = nixpkgs.legacyPackages."${system}";
      in
      rec {

        defaultPackage = pkgs.stdenvNoCC.mkDerivation {
          name = "mypkg";
          src = ./.;
          dontUnpack = true;
          dontConfigure = true;
          dontBuild = true;
          installPhase = ''
            mkdir -p $out/bin
            echo "echo 'Hello, world!'" > $out/bin/hello
            chmod +x $out/bin/hello
          '';
        };

        mypkgShellHook =
          pkgs.makeSetupHook
            {
              name = "mypkg";
              propagatedBuildInputs = [
                pkgs.bash
                defaultPackage
              ];
              substitutions = {
                valueFromNix = "'value from nix!'";
                shell = "${pkgs.bash}/bin/bash";
              };
            }
            (
              pkgs.writeScript "setup.sh" ''
                #!@shell@

                export GREETING="Hello, World!"
                export VALUE_FROM_NIX=@valueFromNix@
              ''
            );
      }
    );
}
```

ã“ã‚Œã ã‘ã§ã‚ã‚‹ã€ `makeSetupHook` ã‚’åˆ©ç”¨ã—ã¦è‡ªåˆ†ã® `ShellHook` ã‚’å®šç¾©ã—ã¦ã‚ã’ã‚Œã°è‰¯ã„ã€‚

## å‘¼ã³å‡ºã—æ–¹

### flake.nix

```nix
{
  description = "Flake shell";
  inputs.nixpkgs.url = "github:NixOS/nixpkgs/nixpkgs-unstable";
  inputs.flake-utils.url = "github:numtide/flake-utils";
  inputs.mypkg.url = "path:./mypkg";

  outputs =
    {
      nixpkgs,
      flake-utils,
      mypkg,
      ...
    }:
    flake-utils.lib.eachDefaultSystem (
      system: {
        devShells.default = pkgs.mkShell { packages = [ mypkg.mypkgShellHook.${system} ]; };
      }
    );
}
```

å‘¼ã³å‡ºã™æ™‚ã¯ `mypkgShellHook` ã‚’ packages ã«æŒ‡å®šã—ã¦ã‚ã’ã‚Œã°è‰¯ã„ã€
ã‚ã¨ã¯ `flake devolp` ã§ãŠå¥½ã¿ã®ç’°å¢ƒã«å…¥ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
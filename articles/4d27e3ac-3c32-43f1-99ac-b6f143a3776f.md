---
title: "SwiftUI ã¨ C++ ã§ GUI ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹"
emoji: "ðŸ¦…"
type: "tech"
topics: ["swift", "cpp", "ninja", "cmake", "mac", "GUI", "metal"]
published: true
---

::::::::message
- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯**ä¸€åˆ‡ä½¿ã‚ãªã„**
- Xcode ã¯**ä¸€åˆ‡ç™»å ´ã—ãªã„**
::::::::

# SwiftUI ã¨ C++

Mac ã«ãŠã„ã¦ GUI ã®é–‹ç™ºã« C++ ã¯å‘ã„ã¦ã„ãªã„ã€‚
åŸºæœ¬çš„ã« Objective-C/Objective-C++ ã‚„ Swift ã‚’ç”¨ã„ã¦é–‹ç™ºã™ã‚‹ã®ãŒã‚»ã‚ªãƒªãƒ¼ã ã£ãŸã€‚
ä»Šã‚„ Swift ã ã‘ã§ç°¡å˜ã« GUI ã‚¢ãƒ—ãƒªã‚’åˆ¶ä½œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
**ã§ã‚‚ C++ ã§ GUI é–‹ç™ºã‚’ã—ãŸã„**
Swift ã¨ Objective-C/Objective-C++ ã‚’ç›¸äº’é‹ç”¨ã™ã‚‹ã“ã¨ãŒã§ããŸãŸã‚ã€ C++ â†” Objective-C++ â†” Swift ã¨ã„ã†æµã‚Œã§ C++ ã‹ã‚‰ SwiftUI ã‚’å·¡ã£ã¦å‘¼ã¶ã“ã¨ã¯ã§ããŸã€‚
**ã—ã‹ã—ã€ Objective-C/Objective-C++ ãªã‚“ã¦æ›¸ããŸããªã„**
ãã†ã„ã†ãªã‹ã€ [C++ â†” Swift](https://www.swift.org/documentation/cxx-interop/) ã‚’ç›¸äº’é‹ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹æ©Ÿèƒ½ãŒ Swift ã«è¿½åŠ ã•ã‚ŒãŸã®ã§ã‚ã‚‹ã€‚

----------

è¦ä»¶ã‚’ä»¥ä¸‹ã«ã¾ã¨ã‚ã‚‹

* Objective-C / Objective-C++ ã¯çµ¶å¯¾ã«æ›¸ããŸããªã„
* Swift + C++ ã®æ§‹æˆã§ SwiftUI ã‚’æ¥½ã«æ›¸ããŸã„
* C++ ã‹ã‚‰ SwiftUI ã‚’å©ã‘ã‚‹ã‚ˆã†ã«ãªã‚ŠãŸã„
* LSP ãªã©ã®è¨€èªžæ”¯æ´ã‚‚é©åˆ‡ã«

## C++ ã¨ Swift ã®ç›¸äº’é‹ç”¨

è©³ã—ã„ã“ã¨ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦æ¬²ã—ã„ã€‚ã“ã“ã§ã¯ã€å…·ä½“çš„ãªæ©Ÿèƒ½ã®èª¬æ˜Žã‚„ã‚³ãƒ¼ãƒ‰ã®è§£èª¬ã¯è¡Œã‚ãªã„ã€‚
C++ ã¨ Swift ã® interop ã®ä¸€ç•ªã‚ã‹ã‚Šã‚„ã™ã„ Example ã¯ [Apple ã®ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/apple/swift-cmake-examples/tree/main/3_bidirectional_cxx_interop) ã«ã‚ã‚‹ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã‚ã‚‹ã€‚
åŸºæœ¬çš„ã«ã“ã“ã‹ã‚‰é€²ã‚ã¦ã„ãã€‚

## LSP ã®æ”¯æ´

ä¸Šè¨˜ã® Example ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€é©å½“ãª LSP ã‚’æŒã¤ã‚¨ãƒ‡ã‚£ã‚¿ã§é–‹ã„ã¦ã‚‚ LSP ã«ã‚ˆã‚‹è£œå®ŒãŒå‡ºã¦ã“ãªã„ã¨æ€ã†ã€‚
C++(clangd) ã‚‚ swift(sourcekit-lsp) ã‚‚ã“ã®ã¾ã¾ã®æ§‹æˆã§ã¯é©åˆ‡ã« LS ãŒæ§‹é€ ã‚’æŠŠæ¡ã—ãã‚Œãªã„ã€‚
ã¾ãšã¯

```shell
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
```

ã§ `compile_commands.json` ã‚’ç”Ÿæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã€‚
ã—ã‹ã—ã“ã® `compile_commands.json` ã‚’ sourcekit-lsp ã¯ç†è§£ã—ãã‚Œãªã„ã€‚
clangd å´ã¯ç†è§£ã§ãã‚‹ãŒãã£ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€ãã†ã„ã†æ™‚ã¯ `.clangd` ã«ä»¥ä¸‹ã®è¨˜è¿°ãŒå¿…è¦ã™ã‚Œã°æ²»ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

```yaml
CompileFlags:
  Add:
    - -I/Library/Developer/CommandLineTools/usr/lib/swift
```

sourcekit-lsp å´ã®å¯¾å‡¦ã¯ã“ã“ã®[ãƒ•ã‚©ãƒ¼ãƒ©ãƒ ](https://forums.swift.org/t/sourcekit-lsp-and-cmake/67956/3)ã«æ›¸ã„ã¦ã‚ã‚‹ã€‚
ãƒ•ã‚©ãƒ¼ãƒ©ãƒ ã®å†…å®¹ã‚’ã¾ã¨ã‚ã‚‹ã¨`compile_commands.json` ã«æ‰‹ã‚’åŠ ãˆã¦ sourcekit-lsp ãŒç†è§£ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã„ã†ã“ã¨ã ã€‚
[https://github.com/apple/foundationdb/blob/main/contrib/gen_compile_db.py](https://github.com/apple/foundationdb/blob/main/contrib/gen_compile_db.py)
ã‚³ãƒ¼ãƒ‰ã‚’ç”¨ã„ã‚‹ã¨è‰¯ã„ã€‚
`gen_compile_db.py` ã‚’é©å½“ãªå ´æ‰€ã«ã‚³ãƒ”ãƒ¼ã‚’ã™ã‚‹ã€‚ãã®ä¸Šã§

```shell
python3 gen_compile_db.py ./build/compile_commands.json -i ./build -b ./build -o compile_commands.json -ninjatool=ninja
```

ã‚’å®Ÿè¡Œã™ã‚Œã° `compile_commands.json` ãŒç”Ÿæˆã•ã‚Œã€ swift ã®è£œå®ŒãŒæ­£ã—ãåƒãã‚ˆã†ã«ãªã‚‹ã€‚

## SwiftUI ã®è¨­å®š

ä¸Šã®ãƒªãƒã‚¸ãƒˆãƒªã® `lib/fibonacci/fibonacci.swift` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã‚‹ã€‚

```swift
import Fibonacci
import AppKit
import SwiftUI

public func fibonacciSwift(_ x: CInt) -> CInt {
  print("x [swift]: \(x)")
  if x <= 1 {
    return 1
  }
  return fibonacci_cpp(x - 1) + fibonacci_cpp(x - 2)
}

class AppDelegate: NSObject, NSApplicationDelegate {
  func applicationDidFinishLaunching(_ aNotification: Notification) {
    NSApp.setActivationPolicy(.regular)
    NSApp.activate(ignoringOtherApps: true)
  }
}

struct ContentView: View {
  var body: some View {
    VStack {
      Text("Hello, World")
    }.padding()
  }
}

struct CxxApp: App {
  @NSApplicationDelegateAdaptor(AppDelegate.self) var appDelegate
  
  var body: some Scene {
    WindowGroup {
      ContentView()
    }
  }
}

public func run() {
  CxxApp.main()
}
```

ãã—ã¦ `src/fibonacci.cpp` ã‚’

```swift
#include "fibonacci/fibonacci-swift.h"
#include <iostream>

int main(int argc, char **argv) {
  std::cout << SwiftFibonacci::fibonacciSwift(5) << std::endl;
  SwiftFibonacci::run();
  return 0;
}
```

ã®ã‚ˆã†ã«ã™ã‚Œã° `./build/src/fibonacci_cpp` ã‹ã‚‰ç„¡äº‹ GUI ã‚¢ãƒ—ãƒªãŒç«‹ã¡ä¸ŠãŒã‚‹ã¯ãšã ã€‚
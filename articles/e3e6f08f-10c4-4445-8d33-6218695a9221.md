---
title: "Nix ã§ import std ã‚’ã™ã‚‹"
emoji: "ğŸ˜œ"
type: "tech"
topics: ["Nix", "cpp", "llvm"]
published: true
---

# ã¯ã˜ã‚ã«

CMake ãŒ [`import std`](https://www.kitware.com/import-std-in-cmake-3-30/) ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã€‚
ãªã‚‰ Nix ã§ä½¿ã‚ã–ã‚‹ã‚’å¾—ãªã„ã ã‚ã†ã€‚
`import std` ã§å¿…è¦ãªã®ã¯äºŒã¤

1. CMake â‰¥ 3.30
1. llvm â‰¥ 19
1. ninja

## CMake

ç¾çŠ¶ nix ã«ã¯ â€œ3.29â€ ã® CMake ã—ã‹å­˜åœ¨ã—ãªã„ã€ãªã®ã§

```nix
(pkgs.cmake.overrideAttrs (oldAttrs: {
  version = "3.30.2";
  src = oldAttrs.src.overrideAttrs { outputHash = null; };
}))
```

ã“ã†æ›¸ãã¨ã€æ–°ã—ã„ â€œ3.30.2â€ ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

## LLVM

nixpkgs ã® llvm ã§ã¯ã¾ã  `import std` ã«å¿…è¦ãª module ã®ã‚½ãƒ¼ã‚¹ã‚’é©åˆ‡ãªå ´æ‰€ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒã§ãã¦ã„ãªã„ã€‚ãªã®ã§ã€è‡ªåˆ†ã§æ›¸ã„ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```nix
(pkgs.llvmPackages_19.libcxxClang.overrideAttrs (oldAttrs: {
  postFixup =
    oldAttrs.postFixup
    + ''
      ln -sf  ${oldAttrs.passthru.libcxx}/lib/libc++.modules.json $out/resource-root/libc++.modules.json
      ln -sf  ${oldAttrs.passthru.libcxx}/share $out
    '';
}))
```

ã–ã£ã¨ã“ã‚“ãªæ„Ÿã˜ã 

## ã¾ã¨ã‚

ã–ã£ã¨ã¾ã¨ã‚ã‚‹ã¨ `packages` ã®è¨­å®šã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚Œã°è‰¯ã„ã€‚

```nix
packages = [
  pkgs.llvmPackages_19.clang-tools
  (pkgs.llvmPackages_19.libcxxClang.overrideAttrs (oldAttrs: {
    postFixup =
      oldAttrs.postFixup
      + ''
        ln -sf  ${oldAttrs.passthru.libcxx}/lib/libc++.modules.json $out/resource-root/libc++.modules.json
        ln -sf  ${oldAttrs.passthru.libcxx}/share $out
      '';
  }))
  (pkgs.cmake.overrideAttrs (oldAttrs: {
    version = "3.30.2";
    src = oldAttrs.src.overrideAttrs { outputHash = null; };
  }))
  pkgs.ninja
];
```

ã‚ã¨ã¯

* `CMakeLists.txt`

```plain text
cmake_minimum_required(VERSION 3.29.20240416 FATAL_ERROR)

set(CMAKE_EXPERIMENTAL_CXX_IMPORT_STD "0e5b6991-d74f-4b3d-a41c-cf096e0b2508")

project(import_std LANGUAGES CXX)
set(CMAKE_CXX_MODULE_STD 1)

add_executable(main)
target_compile_features(
  main
  PRIVATE cxx_std_23
  INTERFACE cxx_std_20)
target_sources(main PRIVATE main.cc)
```

* `main.cc`

```cpp
import std;


auto main() -> int
{
  std::println("Hello, {}!", "world");
  return 0;
}
```

ã‚’æ›¸ã„ã¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã™ã‚‹ã ã‘ï¼
---
title: "C++20 ä»¥é™ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚æ–‡å­—åˆ—æ“ä½œ"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["cpp" ]
published: true
---
# ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ–‡å­—åˆ—

:::message
ä»¥ä¸‹ã®æ–‡ç« ã¯ C++20 ã®ä»•æ§˜ã‚’ãƒ™ãƒ¼ã‚¹ã«è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚C++20 ä»¥é™ã§ãªã‘ã‚Œã°å‹•ã‹ãªã„ã‚³ãƒ¼ãƒ‰ã‚‚ãŸãã•ã‚“å­˜åœ¨ã™ã‚‹ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
:::

## å®Ÿè£…
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«è¨ˆç®—å¯èƒ½ãªæ–‡å­—åˆ—ã‚’è¡¨ã™æ–‡å­—åˆ—

```cpp
template <size_t N>
struct String {
  char str_[N] = {};

  String() = default;

  consteval String(const char (&str)[N + 1]) {
    for (size_t i = 0; i < N; i++) {
      str_[i] = str[i];
    }
  };

  constexpr explicit operator std::string() const {
    return std::string(str_, N);
  }

  constexpr explicit operator std::string_view() const {
    return std::string_view(str_, N);
  }

  [[nodiscard]] consteval auto operator[](size_t n) const {
    return str_[n];
  }

  consteval auto operator[](size_t n) -> char& {
    return str_[n];
  }
};

template <size_t N>
String(const char (&)[N]) -> String<N - 1>;
```

## å‰æçŠ¶æ³

- C++ ã§ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã« `const char *` ã‚’å®£è¨€ã™ã‚‹ã“ã¨ã¯[å¯èƒ½](https://godbolt.org/z/vcPfxqGqx)

```cpp
consteval const char* str = "Hello, World"
```

- ã—ã‹ã—ã“ã‚Œã‚’éå‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å…¥ã‚Œã‚‹ã“ã¨ã¯ã§ããªã„

```cpp
constexpr const char c = 'c';
constexpr const char* c_ptr = &c;

constexpr const char* d_ptr = "Hello, World!";

template <auto T>
struct A {};

A<c_ptr>(); // OK    c_ptr ã¯ literal å‹
A<d_ptr>(); // Error d_ptr ã¯ éliteral å‹
```

- ã¨ã‚“ã§ã‚‚ãªçŠ¶æ³ã ãŒ C++ ã§ã¯ string literal ã¯ literal å‹ã§ã¯ãªãå¾“ã£ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å…¥ã‚Œã‚‹ã“ã¨ã¯ã§ããªã„
- ãã®ä¸Š `std::string` ã‚‚å†…éƒ¨ã§ string literal ã‚’ä¿æœ‰ã—ã¦ã„ã‚‹ãŸã‚ `std::string` ã‚’éå‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦ç”¨ã„ã‚‹ã“ã¨ã¯ã§ããªã„
- ä¸€æ–¹ã§ `char[]` ã®ã‚ˆã†ãªé…åˆ—å‹ã¯ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«è¦ç´ ãŒå®šã¾ã£ã¦ã„ã‚‹é™ã‚Š literal å‹ã¨ãªã‚‹

```cpp
constexpr char[5] = {'H', 'e', 'l', 'l', 'o'};
```

- C++20 ã‹ã‚‰ã¯ constexpr é–¢æ•°ç­‰ã®åˆ¶é™ãŒç·©ã¿ string literal ãŒ constexpr é–¢æ•°å†…ã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸ
- string literal ã‹ã‚‰ literal å‹ã§ã‚ã‚‹é…åˆ—å‹ã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«å¤‰æ›´ã§ãã‚Œã°ã€string literal ã‚’ literal å‹ã®ã‚ˆã†ã«æ‰±ã†ã“ã¨ãŒå¯èƒ½ã«ãªã‚‹

## å®Ÿè£…ã®èª¬æ˜

- ã¾ãšã¯ literal å‹ã¨ãªã‚‹å€¤ã® storage ã‚’è€ƒãˆã‚‹ãã®å‹ãŒ literal å‹ã§ã‚ã‚‹ãŸã‚ã«ã¯
    - é…åˆ—ã®ã‚µã‚¤ã‚ºãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æ±ºã¾ã‚‹
    - `private` ã§ã‚ã‚‹ãƒ¡ãƒ³ãƒãƒ¼å¤‰æ•°ã‚’æŒã£ã¦ã¯ã„ã‘ãªã„

```cpp
template <size_t N>
struct String {
  char str_[N] = {};
};
```

- ã“ã‚Œã‚’ãƒ™ãƒ¼ã‚¹ã§ `cosnt char*` ã‚’ `str_` ã«ä¿æŒã™ã‚‹å®Ÿè£…ã‚’ã™ã‚‹
- ãã®ä¸Šã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ãŒ string literal ã‚’ `const char[]` ã«æ¨è«–ã— `String` ã«æ ¼ç´ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹

```cpp
template <size_t N>
String(const char (&)[N]) -> String<N - 1>;
```

## ä½¿ç”¨ä¾‹

- ã“ã‚Œã‚’ä½¿ã†ã¨ string literal ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«æ ¼ç´å¯èƒ½ã«ãªã‚‹ã€‚ï¼ˆ[ä½¿ç”¨ä¾‹](https://godbolt.org/z/vcPfxqGqx)ï¼‰

```cpp
template <String str>
struct A {
    void print() { std::println("{}", std::string(str)); }
};

int main() {
    auto a = A<"Hello, world!">();
    a.print();
}
```

- ã“ã‚Œã‚’ç”¨ã„ãŸã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚æ±ºå®šã® CLI ãƒ‘ãƒ¼ã‚µãƒ¼ã‚‚å®Ÿè£…ã—ãŸï¼ˆâ†’ [Compiler Exploler](https://godbolt.org/z/8rMxfrdvK))

https://github.com/gen740/Argo.git
